# Architecture Documentation

## OpenCV Integration Strategy

### Problem
The app requires OpenCV for face detection (DNN module), but:
- OpenCV is not available in standard SailfishOS repositories
- System-wide installation would require user manual steps
- Full OpenCV is 100+ MB (too large for bundling)

### Solution: Bundled OpenCV Minimal

We build and bundle a **minimal OpenCV** with only required modules:
- `core` - Basic data structures and algorithms
- `imgproc` - Image processing functions
- `dnn` - Deep Neural Networks module (for YuNet face detection)

**Size**: ~5-8 MB (vs 100+ MB for full OpenCV)

### Build Process

1. **CI/CD Cross-Compilation**
   - GitHub Actions workflow builds OpenCV for aarch64
   - Uses Sailfish OS SDK Docker container with `sb2` (scratchbox2)
   - Cached between builds (30min build → 2min with cache)

2. **CMake Configuration**
   ```cmake
   # Minimal module selection
   -DBUILD_LIST=core,imgproc,dnn

   # Disable all GUI, media I/O, CUDA, etc.
   -DWITH_GTK=OFF -DWITH_FFMPEG=OFF -DWITH_CUDA=OFF ...

   # ARM optimization for Jolla C2
   -DENABLE_NEON=ON -DCPU_BASELINE=NEON
   ```

3. **Installation**
   - Libraries installed to `/usr/lib64/harbour-nami/`
   - App uses RPATH to find bundled libs: `$ORIGIN/../lib64/harbour-nami`
   - No system pollution, fully self-contained

## ONNX Runtime Integration

Similarly bundled for ArcFace face recognition:
- Downloaded pre-built from Microsoft releases
- Version: 1.16.3 (aarch64)
- Installed alongside OpenCV in `/usr/lib64/harbour-nami/`

## Build System

### Single Source of Truth: `rpm/harbour-nami.yaml`

The `.yaml` file is the **only** configuration to maintain:
- Version, dependencies, files
- CMake as build system
- `.spec` file is auto-generated by `mb2` (spectacle)

### Removed
- `harbour-nami.pro` (obsolete QMake config)
- `download_opencv_for_build.sh` (replaced by `build_opencv_minimal.sh`)
- `install_opencv_on_device.sh` (no longer needed)

## Directory Structure

```
harbour-nami/
├── .github/workflows/build.yml    # CI/CD: build OpenCV + app
├── 3rdparty/                      # gitignored, generated by CI
│   ├── opencv/
│   │   ├── include/opencv4/
│   │   └── lib/
│   │       ├── libopencv_core.so*
│   │       ├── libopencv_imgproc.so*
│   │       └── libopencv_dnn.so*
│   └── onnxruntime/
│       ├── include/
│       └── lib/libonnxruntime.so*
├── scripts/
│   ├── build_opencv_minimal.sh    # Cross-compile OpenCV
│   ├── download_models_for_build.sh
│   └── download_onnxruntime.sh
├── CMakeLists.txt                 # Main build system
└── rpm/harbour-nami.yaml          # RPM packaging config
```

## Runtime

```
/usr/bin/harbour-nami              # Main executable (RPATH: $ORIGIN/../lib64/harbour-nami)
/usr/lib64/harbour-nami/           # Bundled libraries
    ├── libopencv_core.so.4.5.5
    ├── libopencv_imgproc.so.4.5.5
    ├── libopencv_dnn.so.4.5.5
    └── libonnxruntime.so.1.16.3
/usr/share/harbour-nami/           # ML models, QML files
    └── python/models/
        ├── face_detection_yunet_2023mar.onnx
        └── arcface_mobilefacenet.onnx
```

## Advantages

1. **Zero user installation** - Everything bundled in RPM
2. **Small package size** - Minimal OpenCV ~5-8 MB
3. **Fast CI builds** - OpenCV cached, rebuild in ~2min
4. **OpenRepos ready** - No Harbour Store restrictions violated
5. **Single architecture** - Optimized for Jolla C2 only

## Disadvantages

1. **CI/CD only** - Local builds require full Sailfish SDK setup
2. **Single target** - aarch64 only (not armv7hl, i486)
3. **OpenCV recompile** - If cache invalidated, 30min build time

## Future Improvements

- Multi-arch support if needed (armv7hl for older devices)
- Further size optimization (strip debug symbols)
- Static linking exploration (single binary)
